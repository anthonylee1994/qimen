# 奇門遁甲算法速查表

快速參考所有重要的算法規則和查表數據。

---

## 排盤流程圖

```
輸入時間
   ↓
計算八字 ──→ 年月日時干支
   ↓
取節氣 ──→ 確定陰遁/陽遁
   ↓
查日干支 ──→ 確定上中下元
   ↓
查節氣+元 ──→ 確定局數(1-9)
   ↓
查時干支 ──→ 確定旬首
   ↓
查旬首 ──→ 確定遁干
   ↓
排地盤 ──→ 局數+陰陽遁→三奇六儀位置
   ↓
轉天盤 ──→ 遁干位置→時干位置
   ↓
排九星 ──→ 跟隨天盤轉動
   ↓
排八門 ──→ 值使門位置+順排
   ↓
排八神 ──→ 時干位置+陰陽遁方向
   ↓
完整奇門盤
```

---

## 核心口訣

### 陰陽遁

```
冬至一陽生 → 冬至起陽遁
夏至一陰生 → 夏至起陰遁
```

### 六儀遁表

```
甲子戊 甲戌己
甲申庚 甲午辛
甲辰壬 甲寅癸
```

### 空亡口訣

```
甲子旬空戌亥
甲戌旬空申酉
甲申旬空午未
甲午旬空辰巳
甲辰旬空寅卯
甲寅旬空子丑
```

### 驛馬口訣

```
寅午戌馬在申
巳酉丑馬在亥
亥卯未馬在巳
申子辰馬在寅
```

---

## 基礎序列

### 三奇六儀序

```
戊 己 庚 辛 壬 癸 丁 丙 乙
```

### 九星序（8星）

```
天蓬 天任 天冲 天輔 天英 天芮 天柱 天心
```
注：天禽（第9星）固定在中五宮

### 八門序

```
休門 生門 傷門 杜門 景門 死門 驚門 開門
```

### 八神序

```
值符 騰蛇 太陰 六合 白虎 玄武 九地 九天
```

---

## 宮位對應

### 九宮位置

```
巽四 離九 坤二
震三 中五 兌七
艮八 坎一 乾六
```

### 飛星序（數組索引）

```
索引：0    1    2    3    4    5    6    7    8
宮位：坎一 坤二 震三 巽四 中五 乾六 兌七 艮八 離九
```

### 轉盤序（轉動順序，逆時針）

```
索引：0    1    2    3    4    5    6    7
宮位：坎一 艮八 震三 巽四 離九 坤二 兌七 乾六
```

### 宮位地支

```
坎一：子
坤二：未申
震三：卯
巽四：辰巳
中五：無
乾六：戌亥
兌七：酉
艮八：丑寅
離九：午
```

---

## 局數表（節氣→[上元,中元,下元]）

### 陽遁節氣

```
冬至: [1, 7, 4]    小寒: [2, 8, 5]    大寒: [3, 9, 6]
立春: [8, 5, 2]    雨水: [9, 6, 3]    惊蛰: [1, 7, 4]
春分: [3, 9, 6]    清明: [4, 1, 7]    谷雨: [5, 2, 8]
立夏: [4, 1, 7]    小满: [5, 2, 8]    芒种: [6, 3, 9]
```

### 陰遁節氣

```
夏至: [9, 3, 6]    小暑: [8, 2, 5]    大暑: [7, 1, 4]
立秋: [2, 5, 8]    处暑: [1, 4, 7]    白露: [9, 3, 6]
秋分: [7, 1, 4]    寒露: [6, 9, 3]    霜降: [5, 8, 2]
立冬: [6, 9, 3]    小雪: [5, 8, 2]    大雪: [4, 7, 1]
```

---

## 旺相休囚死表

```
月令    旺  相  休  囚  死
──────────────────────
子亥    水  木  金  土  火
寅卯    木  火  水  金  土
巳午    火  土  木  水  金
申酉    金  水  土  火  木
辰戌丑未 土  金  火  木  水
```

---

## 計算公式

### 地盤干排列

```typescript
// 從局數宮開始，按方向排列三奇六儀序
陽遁：順時針（索引 +1）
陰遁：逆時針（索引 -1）

for i = 0 to 8:
  index = (局數-1 + i * 方向) % 9
  地盤干[index] = 三奇六儀序[i]
```

### 天盤干轉動

```typescript
// 將遁干位置轉到時干位置
遁干索引 = 地盤干.indexOf(遁干)  // 轉盤序
時干索引 = 值符落宮.indexOf()     // 轉盤序

for i = 0 to 8:
  天盤[時干索引+i] = 地盤[遁干索引+i]
```

### 九星轉動

```typescript
// 與天盤干同步轉動
遁干索引 = 地盤干.indexOf(遁干)
時干索引 = 值符落宮.indexOf()

for i = 0 to 7:  // 只有8顆星
  九星[時干索引+i] = 九星序[遁干索引+i]
```

### 八門排列

```typescript
// 從值使門位置開始順排（無陰陽遁之分）
值使門索引 = 八門序.indexOf(值使門)
值使宮索引 = 宮位序.indexOf(值使落宮)

for i = 0 to 7:
  八門[值使宮索引+i] = 八門序[值使門索引+i]
```

### 八神排列

```typescript
// 從時干位置開始，陽遁順排、陰遁逆排
時干索引 = 值符落宮.indexOf()

if 陽遁:
  for i = 0 to 7:
    八神[時干索引+i] = 八神序[i]
else:
  for i = 0 to 7:
    八神[時干索引-i] = 八神序[i]
```

---

## 特殊規則

### 中五宮寄宮

```
1. 地盤干：中五宮的地盤干寄於坤二宮
2. 天盤干：中五宮的地盤干寄於天芮星所在宮
3. 計算索引：當在中五宮時，視為坤二宮（轉盤序索引5）
4. 天禽星：固定在中五宮，不參與轉動
```

### 甲時規則

```
時干為"甲"時：
- 值符落宮使用遁干位置（因甲被遁）
- 天盤干不顯示甲，用遁干代替
```

### 循環數計算

```typescript
function 循環數(num: number, min: number, max: number): number {
  const range = max - min + 1
  const adjustedNum = num - min
  const remainder = ((adjustedNum % range) + range) % range
  return remainder + min
}

// 確保索引永遠在有效範圍內
循環數(9, 0, 7) → 1
循環數(-1, 0, 7) → 7
```

---

## 吉凶判斷參考

### 吉門

```
開門、休門、生門
```

### 凶門

```
死門、驚門、傷門
```

### 平門

```
杜門、景門
```

### 吉星

```
天心、天任、天輔、天英（部分情況）
```

### 凶星

```
天蓬、天芮
```

### 平星

```
天冲、天柱、天禽
```

### 吉神

```
值符、六合、太陰、九天
```

### 凶神

```
白虎、玄武、騰蛇（部分情況）
```

---

## 快速檢查清單

排盤完成後檢查：

- [ ] 陰陽遁是否正確（根據節氣）
- [ ] 局數是否在1-9之間
- [ ] 旬首是否為六甲之一
- [ ] 遁干是否為六儀之一
- [ ] 地盤干是否為完整的三奇六儀（9個）
- [ ] 天盤干是否有8個（中五宮為undefined）
- [ ] 九星是否有8個（中五宮為undefined）
- [ ] 八門是否有8個（中五宮為undefined）
- [ ] 八神是否有8個（中五宮為undefined）
- [ ] 空亡是否為2個地支
- [ ] 驛馬是否為四驛馬之一

---

## 常見錯誤

### 1. 索引越界

```
問題：循環計算時索引超出範圍
解決：使用循環數函數，確保索引在 0-7 或 0-8 範圍內
```

### 2. 飛星序與轉盤序混淆

```
問題：轉動計算錯誤
解決：
  - 存儲用飛星序（0-8）
  - 計算用轉盤序（0-7，不含中五）
  - 使用映射表轉換
```

### 3. 中五宮處理錯誤

```
問題：中五宮計算異常
解決：
  - 索引4（飛星序）為中五宮
  - 轉盤序不含中五宮
  - 中五宮結果為 undefined
  - 需要時寄於坤二宮
```

### 4. 陰陽遁方向錯誤

```
問題：八神方向錯誤
解決：
  - 陽遁：順時針（+1）
  - 陰遁：逆時針（-1）
  - 八門永遠順排（無陰陽遁之分）
```

---

## 驗證方法

### 手工驗證步驟

1. 準備傳統萬年曆或排盤工具
2. 輸入相同的時間
3. 對比以下關鍵點：
   - 節氣是否一致
   - 陰陽遁是否正確
   - 局數是否相同
   - 值符值使位置
   - 各宮三奇六儀分布

### 程序驗證

```typescript
// 運行測試套件
pnpm test

// 運行驗證腳本
ts-node src/scripts/validate.ts
```

---

## 參考資源

- [ALGORITHM.md](./ALGORITHM.md) - 完整算法文檔
- [EXAMPLES.md](./EXAMPLES.md) - 使用示例
- [QUICKSTART.md](./QUICKSTART.md) - 快速入門
- [測試文件](./src/qimen/__tests__/QimenUtil.test.ts) - 所有測試用例

---

**最後更新**：2026-02-08  
**適用版本**：1.0.0
