# 奇門遁甲排盤算法完整文檔

## 概述

本文檔詳細記錄了完整的奇門遁甲排盤算法，包含所有計算步驟、數據表、以及實現細節。此文檔旨在保存這套完整的算法體系，以防失傳。

## 目錄

1. [核心概念](#核心概念)
2. [基礎數據結構](#基礎數據結構)
3. [查表數據](#查表數據)
4. [排盤算法流程](#排盤算法流程)
5. [詳細計算步驟](#詳細計算步驟)
6. [特殊規則](#特殊規則)
7. [完整示例](#完整示例)

---

## 核心概念

### 奇門遁甲基本要素

奇門遁甲排盤需要計算以下要素：

1. **時間信息**：八字（年月日時干支）、節氣
2. **局數信息**：陰遁/陽遁、上中下元、局數（1-9局）
3. **天盤要素**：天盤干、九星、八神、八門
4. **地盤要素**：地盤干（三奇六儀）
5. **輔助信息**：值符、值使、旬首、遁干、空亡、驛馬、天乙、旺相休囚死

### 九宮格式

奇門遁甲使用洛書九宮排列：

```
巽四宮 | 離九宮 | 坤二宮
-------+-------+-------
震三宮 | 中五宮 | 兌七宮
-------+-------+-------
艮八宮 | 坎一宮 | 乾六宮
```

飛星序（數組索引0-8）：`[坎一, 坤二, 震三, 巽四, 中五, 乾六, 兌七, 艮八, 離九]`

轉盤序（用於轉動計算）：`[坎一, 艮八, 震三, 巽四, 離九, 坤二, 兌七, 乾六]`（不含中五）

---

## 基礎數據結構

### 類型定義

```typescript
// 基本元素
type 五行 = "木" | "火" | "土" | "金" | "水"
type 天干 = "甲" | "乙" | "丙" | "丁" | "戊" | "己" | "庚" | "辛" | "壬" | "癸"
type 地支 = "子" | "丑" | "寅" | "卯" | "辰" | "巳" | "午" | "未" | "申" | "酉" | "戌" | "亥"
type 六十甲子 = `${陽天干}${陽地支}` | `${陰天干}${陰地支}`

// 奇門專用
type 旬首 = "甲子" | "甲寅" | "甲辰" | "甲午" | "甲申" | "甲戌"
type 三奇 = "乙" | "丙" | "丁"
type 六儀 = "戊" | "己" | "庚" | "辛" | "壬" | "癸"
type 三奇六儀 = 三奇 | 六儀
type 上中下元 = "上元" | "中元" | "下元"
type 遁 = "陽遁" | "陰遁"
type 局數 = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9

// 九宮要素
type 宮位 = "坎一宮" | "坤二宮" | "震三宮" | "巽四宮" | "中五宮" | 
           "乾六宮" | "兌七宮" | "艮八宮" | "離九宮"
type 八神 = "值符" | "騰蛇" | "太陰" | "六合" | "白虎" | "玄武" | "九地" | "九天"
type 九星 = "天蓬" | "天任" | "天冲" | "天輔" | "天英" | "天芮" | "天柱" | "天心" | "天禽"
type 八門 = "休門" | "生門" | "傷門" | "杜門" | "景門" | "死門" | "驚門" | "開門"

// 輔助
type 四驛馬 = "申" | "巳" | "亥" | "寅"
```

---

## 查表數據

### 1. 三奇六儀序

從戊開始順序排列：

```typescript
const 三奇六儀序 = ["戊", "己", "庚", "辛", "壬", "癸", "丁", "丙", "乙"]
```

### 2. 天干序

```typescript
const 天干序 = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
```

### 3. 九星序

```typescript
const 九星序 = ["天蓬", "天任", "天冲", "天輔", "天英", "天芮", "天柱", "天心"]
```

注意：天禽（第9星）不在序列中，因為它固定在中五宮。

### 4. 八神序

```typescript
const 八神序 = ["值符", "騰蛇", "太陰", "六合", "白虎", "玄武", "九地", "九天"]
```

### 5. 八門序

```typescript
const 八門序 = ["休門", "生門", "傷門", "杜門", "景門", "死門", "驚門", "開門"]
```

### 6. 旬首表

六十甲子分為六旬：

```typescript
const 旬首表 = {
  甲子: ["甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉"],
  甲戌: ["甲戌", "乙亥", "丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未"],
  甲申: ["甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳"],
  甲午: ["甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑", "壬寅", "癸卯"],
  甲辰: ["甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑"],
  甲寅: ["甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"]
}
```

### 7. 六儀遁表（旬首對應遁干）

```typescript
const 六儀遁表 = {
  甲子: "戊",
  甲戌: "己",
  甲申: "庚",
  甲午: "辛",
  甲辰: "壬",
  甲寅: "癸"
}
```

### 8. 空亡表

```typescript
const 空亡表 = {
  甲子: ["戌", "亥"],
  甲戌: ["申", "酉"],
  甲申: ["午", "未"],
  甲午: ["辰", "巳"],
  甲辰: ["寅", "卯"],
  甲寅: ["子", "丑"]
}
```

### 9. 驛馬表

```typescript
const 驛馬表 = {
  申: ["寅", "午", "戌"],  // 寅午戌馬在申
  巳: ["亥", "卯", "未"],  // 亥卯未馬在巳
  亥: ["巳", "酉", "丑"],  // 巳酉丑馬在亥
  寅: ["申", "子", "辰"]   // 申子辰馬在寅
}
```

### 10. 上中下元表

每元包含20個日干支：

```typescript
const 上中下元表 = {
  上元: ["甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己卯", "庚辰", "辛巳", "壬午", "癸未",
         "甲午", "乙未", "丙申", "丁酉", "戊戌", "己酉", "庚戌", "辛亥", "壬子", "癸丑"],
  中元: ["己巳", "庚午", "辛未", "壬申", "癸酉", "甲申", "乙酉", "丙戌", "丁亥", "戊子",
         "己亥", "庚子", "辛丑", "壬寅", "癸卯", "甲寅", "乙卯", "丙辰", "丁巳", "戊午"],
  下元: ["甲戌", "乙亥", "丙子", "丁丑", "戊寅", "己丑", "庚寅", "辛卯", "壬辰", "癸巳",
         "甲辰", "乙巳", "丙午", "丁未", "戊申", "己未", "庚申", "辛酉", "壬戌", "癸亥"]
}
```

### 11. 節氣遁表

24節氣分為陰遁和陽遁：

```typescript
const 節氣遁表 = {
  陽遁: ["冬至", "惊蛰", "小寒", "大寒", "春分", "雨水", 
         "清明", "立夏", "立春", "谷雨", "小满", "芒种"],
  陰遁: ["夏至", "白露", "小暑", "大暑", "秋分", "立秋", 
         "寒露", "立冬", "处暑", "霜降", "小雪", "大雪"]
}
```

口訣：
- **冬至一陽生**：冬至開始陽遁
- **夏至一陰生**：夏至開始陰遁

### 12. 局數表

每個節氣對應三個局數（上中下元）：

```typescript
const 局數表 = {
  // 陽遁節氣
  冬至: [1, 7, 4],
  惊蛰: [1, 7, 4],
  小寒: [2, 8, 5],
  大寒: [3, 9, 6],
  春分: [3, 9, 6],
  雨水: [9, 6, 3],
  清明: [4, 1, 7],
  立夏: [4, 1, 7],
  立春: [8, 5, 2],
  谷雨: [5, 2, 8],
  小满: [5, 2, 8],
  芒种: [6, 3, 9],
  
  // 陰遁節氣
  夏至: [9, 3, 6],
  白露: [9, 3, 6],
  小暑: [8, 2, 5],
  大暑: [7, 1, 4],
  秋分: [7, 1, 4],
  立秋: [2, 5, 8],
  寒露: [6, 9, 3],
  立冬: [6, 9, 3],
  处暑: [1, 4, 7],
  霜降: [5, 8, 2],
  小雪: [5, 8, 2],
  大雪: [4, 7, 1]
}
```

### 13. 旺相休囚死表

按月支查五行旺衰：

```typescript
const 旺相休囚死表 = {
  子: ["水", "木", "金", "土", "火"],  // 冬月
  亥: ["水", "木", "金", "土", "火"],
  
  寅: ["木", "火", "水", "金", "土"],  // 春月
  卯: ["木", "火", "水", "金", "土"],
  
  巳: ["火", "土", "木", "水", "金"],  // 夏月
  午: ["火", "土", "木", "水", "金"],
  
  申: ["金", "水", "土", "火", "木"],  // 秋月
  酉: ["金", "水", "土", "火", "木"],
  
  辰: ["土", "金", "火", "木", "水"],  // 四季月
  戌: ["土", "金", "火", "木", "水"],
  丑: ["土", "金", "火", "木", "水"],
  未: ["土", "金", "火", "木", "水"]
}
```

順序：旺、相、休、囚、死

### 14. 宮位地支表

每個宮位包含的地支：

```typescript
const 宮位地支表 = {
  坎一宮: ["子"],
  坤二宮: ["未", "申"],
  震三宮: ["卯"],
  巽四宮: ["辰", "巳"],
  中五宮: [],
  乾六宮: ["戌", "亥"],
  兌七宮: ["酉"],
  艮八宮: ["丑", "寅"],
  離九宮: ["午"]
}
```

---

## 排盤算法流程

### 主流程

```
輸入：公曆日期時間
  ↓
1. 計算農曆及八字（年月日時干支）
  ↓
2. 計算節氣
  ↓
3. 確定陰遁/陽遁
  ↓
4. 確定上中下元
  ↓
5. 查詢局數
  ↓
6. 計算旬首
  ↓
7. 查詢遁干
  ↓
8. 計算地盤干（三奇六儀布局）
  ↓
9. 計算值符落宮
  ↓
10. 計算天盤干
  ↓
11. 計算九星
  ↓
12. 計算值使門
  ↓
13. 計算八門
  ↓
14. 計算八神
  ↓
15. 計算天乙星
  ↓
16. 計算空亡、驛馬、旺相休囚死
  ↓
輸出：完整奇門盤
```

---

## 詳細計算步驟

### 步驟 1: 計算八字

使用農曆庫計算：

```typescript
function 八字(lunar: Lunar): 八字 {
  return [
    年干支(lunar),  // 年柱
    月干支(lunar),  // 月柱
    日干支(lunar),  // 日柱
    時干支(lunar)   // 時柱
  ]
}
```

### 步驟 2: 計算節氣

使用農曆庫獲取當前時間所處的節氣（取上一個節或氣）：

```typescript
function 節氣(lunar: Lunar): JieQi {
  return lunar.getPrevJieQi(true)
}
```

### 步驟 3: 確定陰遁或陽遁

根據節氣查表：

```typescript
function 陰遁或陽遁(節氣: 節氣): 遁 {
  if (節氣遁表.陽遁.includes(節氣)) return "陽遁"
  if (節氣遁表.陰遁.includes(節氣)) return "陰遁"
}
```

**記憶口訣**：
- 冬至一陽生 → 冬至開始陽遁
- 夏至一陰生 → 夏至開始陰遁

### 步驟 4: 確定上中下元

根據日干支查表：

```typescript
function 上中下元(日干支: 六十甲子): 上中下元 {
  if (上中下元表.上元.includes(日干支)) return "上元"
  if (上中下元表.中元.includes(日干支)) return "中元"
  if (上中下元表.下元.includes(日干支)) return "下元"
}
```

### 步驟 5: 查詢局數

根據節氣和上中下元查表：

```typescript
function 局數(節氣: 節氣, 上中下元: 上中下元): 局數 {
  const [上元, 中元, 下元] = 局數表[節氣]
  return { 上元, 中元, 下元 }[上中下元]
}
```

### 步驟 6: 計算旬首

根據時干支查表，找出所屬的旬：

```typescript
function 旬首(時干支: 六十甲子): 旬首 {
  for (const [旬, 干支列表] of Object.entries(旬首表)) {
    if (干支列表.includes(時干支)) return 旬 as 旬首
  }
}
```

### 步驟 7: 查詢遁干

根據旬首查表：

```typescript
function 遁干(旬首: 旬首): 六儀 {
  return 六儀遁表[旬首]
}
```

**六儀遁口訣**：
- 甲子戊 (甲子旬遁戊)
- 甲戌己 (甲戌旬遁己)
- 甲申庚 (甲申旬遁庚)
- 甲午辛 (甲午旬遁辛)
- 甲辰壬 (甲辰旬遁壬)
- 甲寅癸 (甲寅旬遁癸)

### 步驟 8: 計算地盤干

這是地盤三奇六儀的布局，根據局數和陰陽遁確定：

```typescript
function 地盤干(遁: 遁, 局數: 局數): 三奇六儀[] {
  const arr: 三奇六儀[] = []
  const start = 局數 - 1  // 轉換為0-based索引
  
  // 從局數宮開始，按陰陽遁方向排列三奇六儀序
  for (let i = 0; i < 9; i++) {
    const index = 循環數(
      start + i * (遁 === "陽遁" ? 1 : -1), 
      0, 
      8
    )
    arr[index] = 三奇六儀序[i]
  }
  
  return arr
}
```

**原理**：
- 三奇六儀序：`["戊", "己", "庚", "辛", "壬", "癸", "丁", "丙", "乙"]`
- 陽遁：從局數宮開始，順時針（索引+1）排列
- 陰遁：從局數宮開始，逆時針（索引-1）排列
- 數組按飛星序索引：`[坎一, 坤二, 震三, 巽四, 中五, 乾六, 兌七, 艮八, 離九]`

**示例**：陽遁五局
- 局數5 → 從中五宮（索引4）開始
- 戊 → 索引4（中五）
- 己 → 索引5（乾六）
- 庚 → 索引6（兌七）
- ...順時針排列

### 步驟 9: 計算值符落宮

值符是九星之首，其位置決定了九星的整體位置：

```typescript
function 值符落宮(地盤干: 三奇六儀[], 遁干: 六儀, 時干: 天干): [九星, 宮位] {
  // 將地盤干從飛星序轉換為轉盤序
  const 地盤干轉盤序 = 飛星轉轉盤序.map(i => 地盤干[i - 1])
  
  // 在轉盤序中找到時干和遁干的位置
  const 時干索引 = 地盤干轉盤序.findIndex(干 => 干 === 時干)
  const 遁干索引 = 地盤干轉盤序.findIndex(干 => 干 === 遁干)
  
  // 值符星：遁干所在位置的九星
  const 值符星 = 遁干索引 === -1 ? "天禽" : 九星序[遁干索引]
  
  // 值符宮位：時干所在宮位（甲時用遁干位置）
  const 索引 = 時干 === "甲" ? 遁干索引 : 時干索引
  const 值符宮 = 索引 === -1 ? "中五宮" : 宮位轉盤序[索引]
  
  return [值符星, 值符宮]
}
```

**特殊規則**：
- 時干為"甲"時，使用遁干位置
- 遁干在中五宮時，索引為-1，值符為天禽，落坤二宮（寄宮）

### 步驟 10: 計算天盤干

天盤干是地盤干轉動後的結果：

```typescript
function 天盤干(地盤干: 三奇六儀[], 遁干: 六儀, 時干: 天干): (三奇六儀 | undefined)[] {
  const result: (三奇六儀 | undefined)[] = []
  
  // 轉換為轉盤序
  const 地盤干轉盤序 = 飛星轉轉盤序.map(i => 地盤干[i - 1])
  
  // 計算遁干索引和時干索引
  const 遁干索引 = 計算遁干索引(地盤干, 遁干)
  const 時干索引 = 計算時干索引(地盤干, 遁干, 時干)
  
  // 轉動：將遁干索引位置轉到時干索引位置
  for (let i = 0; i < 9; i++) {
    result[循環數(時干索引 + i, 0, 7)] = 
      地盤干轉盤序[循環數(遁干索引 + i, 0, 7)]
  }
  
  // 轉回飛星序
  return 轉盤轉飛星序.map(i => i ? result[i - 1] : undefined)
}
```

**原理**：
- 天盤以時干為主，將遁干位置轉到時干位置
- 其他天干依次跟隨轉動
- 中五宮（索引4）不參與轉動，結果為undefined

### 步驟 11: 計算九星

九星的排列與天盤干類似，但使用九星序：

```typescript
function 九星(地盤干: 三奇六儀[], 遁干: 六儀, 時干: 天干): (九星 | undefined)[] {
  const arr: (九星 | undefined)[] = []
  
  const 遁干索引 = 計算遁干索引(地盤干, 遁干)
  const 時干索引 = 計算時干索引(地盤干, 遁干, 時干)
  
  // 九星跟隨轉動
  for (let i = 0; i < 8; i++) {
    arr[循環數(時干索引 + i, 0, 7)] = 
      九星序[循環數(遁干索引 + i, 0, 7)]
  }
  
  // 轉回飛星序
  return 轉盤轉飛星序.map(i => i ? arr[i - 1] : undefined)
}
```

**注意**：
- 九星序只有8個星（天蓬到天心）
- 天禽固定在中五宮，不在轉動序列中
- 循環範圍是0-7（共8個位置）

### 步驟 12: 計算值使門

值使門是八門之首，決定八門的位置：

```typescript
function 值使門(地盤干: 三奇六儀[], 遁: 遁, 遁干: 六儀, 時干: 天干): [八門, 宮位] {
  // 轉換為轉盤序
  const 地盤干轉盤序 = 飛星轉轉盤序.map(i => 地盤干[i - 1])
  
  // 找到遁干在地盤的位置
  const 遁干索引 = 地盤干轉盤序.findIndex(干 => 干 === 遁干)
  
  // 八門飛星序（固定：休門坎一、生門艮八、傷門震三...）
  const 八門飛星序 = 轉盤轉飛星序.map(i => i ? 八門序[i - 1] : undefined)
  
  // 值使門：遁干位置的八門
  const 門 = 八門序[遁干索引 === -1 ? 5 : 遁干索引]
  
  // 值使門位置：遁干宮位 + 時干偏移
  const 宮位數 = 遁干索引 === -1 ? 4 : 八門飛星序.indexOf(八門序[遁干索引])
  const 偏移 = 天干序.indexOf(時干) * (遁 === "陽遁" ? 1 : -1)
  const 落宮 = 宮位飛星序[循環數(宮位數 + 偏移, 0, 8)]
  
  return [門, 落宮]
}
```

**原理**：
- 八門固定對應宮位：休門→坎一，生門→艮八，傷門→震三...
- 值使門是遁干位置的門
- 落宮：從遁干宮開始，按天干序偏移（陽順陰逆）

### 步驟 13: 計算八門

根據值使門的位置，排列八門：

```typescript
function 八門(值使門: 八門, 宮位: 宮位): (八門 | undefined)[] {
  const arr: (八門 | undefined)[] = []
  
  // 值使門的宮位索引（轉盤序）
  const 宮位索引 = 宮位轉盤序.indexOf(宮位 === "中五宮" ? "坤二宮" : 宮位)
  
  // 值使門在八門序中的索引
  const 門索引 = 八門序.indexOf(值使門)
  
  // 從值使門位置開始，順序排列八門
  for (let i = 0; i < 8; i++) {
    arr[循環數(宮位索引 + i, 0, 7)] = 
      八門序[循環數(門索引 + i, 0, 7)]
  }
  
  // 轉回飛星序
  return 轉盤轉飛星序.map(i => i ? arr[i - 1] : undefined)
}
```

**注意**：
- 中五宮寄於坤二宮
- 八門永遠順排（無陰陽遁之分）

### 步驟 14: 計算八神

八神根據陰陽遁有不同的排列方向：

```typescript
function 八神(地盤干: 三奇六儀[], 遁: 遁, 遁干: 六儀, 時干: 天干): (八神 | undefined)[] {
  const result: (八神 | undefined)[] = []
  
  // 計算時干索引（八神以時干為主）
  const 時干索引 = 計算時干索引(地盤干, 遁干, 時干)
  
  // 排列八神
  for (let i = 0; i < 8; i++) {
    if (遁 === "陽遁") {
      result[循環數(時干索引 + i, 0, 7)] = 八神序[i]
    } else {
      result[循環數(時干索引 - i, 0, 7)] = 八神序[i]
    }
  }
  
  // 轉回飛星序
  return 轉盤轉飛星序.map(i => i ? result[i - 1] : undefined)
}
```

**原理**：
- 八神以時干為主（值符落宮位置）
- 陽遁順排，陰遁逆排
- 中五宮無八神

### 步驟 15: 計算天乙星

天乙星是時干在天盤的位置對應的九星：

```typescript
function 天乙(天盤干: (三奇六儀 | undefined)[], 九星: (九星 | undefined)[], 時干: 天干): 九星 {
  // 在天盤找到時干的位置
  const index = 天盤干.findIndex(干 => 干 === 時干)
  
  // 返回該位置的九星（若在中五宮或找不到，返回天禽）
  return index === -1 || index === 4 ? "天禽" : 九星[index] as 九星
}
```

### 步驟 16: 計算輔助信息

#### 空亡

根據旬首查表：

```typescript
function 空亡(旬首: 旬首): [地支, 地支] {
  return 空亡表[旬首]
}
```

#### 驛馬

根據時支查表：

```typescript
function 驛馬(時支: 地支): 四驛馬 {
  for (const [馬, 支列表] of Object.entries(驛馬表)) {
    if (支列表.includes(時支)) return 馬 as 四驛馬
  }
}
```

**口訣**：
- 寅午戌馬在申
- 巳酉丑馬在亥
- 亥卯未馬在巳
- 申子辰馬在寅

#### 旺相休囚死

根據月支查表：

```typescript
function 旺相休囚死(月支: 地支): [五行, 五行, 五行, 五行, 五行] {
  return 旺相休囚死表[月支]
}
```

---

## 特殊規則

### 1. 中五宮寄宮規則

中五宮沒有實體位置，需要寄於其他宮：
- **地盤干**：中五宮的地盤干寄於坤二宮
- **天盤干**：中五宮的地盤干寄於天芮星所在宮（即坤二宮的天盤干）
- **計算索引**：當遁干或時干在中五宮時，索引視為坤二宮（轉盤序索引5）

### 2. 時干為"甲"的規則

甲為十干之首，被六儀所遁：
- **值符落宮**：甲時使用遁干的位置作為值符落宮
- **天盤干**：甲在天盤不顯示，用遁干代替

### 3. 循環數計算

所有轉動計算都使用循環數，確保索引在有效範圍內：

```typescript
function 循環數(num: number, min: number, max: number): number {
  const range = max - min + 1
  const adjustedNum = num - min
  const remainder = ((adjustedNum % range) + range) % range
  return remainder + min
}
```

**示例**：
- `循環數(9, 0, 7)` → 1 （9超出範圍，循環回1）
- `循環數(-1, 0, 7)` → 7 （-1變為7）

### 4. 飛星序與轉盤序轉換

九宮格有兩種索引方式：

**飛星序（數組存儲順序）**：
```
[0]坎一, [1]坤二, [2]震三, [3]巽四, [4]中五, 
[5]乾六, [6]兌七, [7]艮八, [8]離九
```

**轉盤序（轉動計算順序，逆時針）**：
```
[0]坎一, [1]艮八, [2]震三, [3]巽四, 
[4]離九, [5]坤二, [6]兌七, [7]乾六
（不含中五宮）
```

**轉換映射**：
```typescript
// 飛星序 → 轉盤序
const 飛星轉轉盤序 = [1, 8, 3, 4, 9, 2, 7, 6]
// 飛星[i] → 轉盤[飛星轉轉盤序[i] - 1]

// 轉盤序 → 飛星序
const 轉盤轉飛星序 = [1, 6, 3, 4, undefined, 8, 7, 2, 5]
// 轉盤[i] → 飛星[轉盤轉飛星序[i] - 1]
```

---

## 完整示例

### 示例 1：陽遁五局

**輸入**：
- 公曆：2024年5月10日 14時30分
- 農曆：甲辰年 己巳月 癸未日 己未時
- 節氣：立夏（上一個節氣）

**計算過程**：

1. **八字**：[甲辰, 己巳, 癸未, 己未]
2. **節氣**：立夏
3. **陰陽遁**：立夏 → 陽遁
4. **上中下元**：癸未 → 上元
5. **局數**：立夏上元 → 4局
6. **時干支**：己未
7. **旬首**：己未在甲午旬 → 甲午
8. **遁干**：甲午 → 辛

9. **地盤干（陽遁4局）**：
   - 從巽四宮（索引3）開始順排
   - 結果：`["丁", "丙", "乙", "戊", "己", "庚", "辛", "壬", "癸"]`

10. **值符落宮**：
    - 遁干辛在兌七宮（轉盤序索引6）
    - 時干己在乾六宮（轉盤序索引7）
    - 值符星：天柱（九星序[6]）
    - 值符宮：乾六宮

11. **天盤干**：
    - 將遁干位置（索引6）轉到時干位置（索引7）
    - 結果：`["壬", "辛", "庚", "己", undefined, "戊", "乙", "丙", "丁"]`

12. **九星**：
    - 同樣轉動九星序
    - 結果：`["天任", "天柱", "天芮", "天心", undefined, "天禽", "天輔", "天冲", "天英"]`

13. **值使門**：
    - 遁干辛在轉盤序索引6，對應驚門
    - 時干己（索引5），陽遁+5步
    - 值使門：驚門，落巽四宮

14. **八門**：
    - 從驚門巽四宮開始順排
    - 結果：`["生門", "景門", "傷門", "驚門", undefined, "死門", "杜門", "休門", "開門"]`

15. **八神（陽遁）**：
    - 從時干位置（乾六宮）開始順排
    - 結果：`["六合", "九天", "騰蛇", "太陰", undefined, "白虎", "值符", "玄武", "九地"]`

16. **天乙星**：
    - 時干己在天盤索引5（乾六宮）
    - 對應九星：天禽

17. **空亡**：甲午旬 → [辰, 巳]
18. **驛馬**：未時 → 巳
19. **旺相休囚死**：巳月 → [火, 土, 木, 水, 金]

---

## 算法核心要點總結

### 1. 基礎框架
- **時間體系**：節氣 + 八字 + 旬首
- **空間體系**：九宮飛星 + 轉盤轉動
- **元素體系**：三奇六儀 + 九星 + 八門 + 八神

### 2. 計算核心
- **定局**：節氣 + 上中下元 → 局數（1-9）
- **定盤**：局數 + 陰陽遁 → 地盤干布局
- **轉盤**：遁干位置 → 時干位置的轉動

### 3. 關鍵規則
- 陽遁順時針，陰遁逆時針
- 中五宮寄坤二宮
- 甲時用遁干位置
- 八門永遠順排
- 八神陰陽遁方向不同

### 4. 數據結構
- 飛星序（存儲）：0-8數組索引
- 轉盤序（計算）：0-7循環轉動
- 循環數函數：確保索引永不越界

---

## 算法驗證

本算法經過完整測試，包含：
- 18種陰陽遁組合的地盤干測試
- 180個天盤干測試案例
- 120個八神測試案例
- 90個九星測試案例
- 88個八門測試案例
- 所有輔助信息（空亡、驛馬等）測試

所有測試用例請參考：`src/qimen/__tests__/QimenUtil.test.ts`

---

## 參考資料

### 核心文件
- `src/qimen/QimenUtil.ts` - 主算法實現
- `src/qimen/type.ts` - 類型定義
- `src/qimen/dictionary.ts` - 查表數據
- `src/qimen/LunarUtil.ts` - 農曆工具
- `src/qimen/FormatUtil.ts` - 格式化工具

### 依賴庫
- `lunar-typescript` - 農曆計算庫（https://github.com/6tail/lunar-typescript）

---

## 結語

本文檔完整記錄了奇門遁甲排盤的算法實現，包含所有查表數據、計算步驟、特殊規則。這套算法經過嚴謹測試，可以準確計算任意時間的奇門盤。

希望這份文檔能夠幫助後人理解和傳承這門古老的術數學問。

---

**文檔版本**：1.0  
**最後更新**：2026年2月8日  
**作者**：qimen project  
**項目地址**：https://github.com/yourusername/qimen
